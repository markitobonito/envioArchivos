# Minimal modern compose file
# Tailscale corre en el HOST (macOS), no en Docker
services:
  quic-file-transfer:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:5000"  # Flask web server
      - "9999:9999/udp"  # QUIC server (UDP)
    volumes:
      - ./app:/app
      - ./certs:/certs
      - ./certs:/app/certs
      - ./app/uploads:/app/uploads
      - ${DOWNLOADS_PATH:-$HOME/Downloads}:/root/Downloads
      # Montar el status.json generado por el host Tailscale (fallback)
      - ${SCRIPT_DIR:-./}/app/tailscale_status.json:/app/tailscale_status.json:ro
      # Montar el socket de Tailscale del HOST para que el contenedor pueda ejecutar 'tailscale status --json'
      - /var/run/tailscale/:/var/run/tailscale/:ro
      - /run/tailscale/:/run/tailscale/:ro
    working_dir: /app
    environment:
      FLASK_APP: "run.py"
      TAILSCALE_STATUS_PATH: "/app/tailscale_status.json"
      HOST_TAILSCALE_IP: "${HOST_TAILSCALE_IP:-127.0.0.1}"
    privileged: false
    restart: unless-stopped
    user: "0"
    command: "python3 /run.py"

networks:
  default:
    driver: bridge