<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® ALERTA CR√çTICA üö®</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial Black', sans-serif;
            overflow: hidden;
            background: #000;
        }

        /* Contenedor principal - PANTALLA COMPLETA */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #FF0000, #FF6600, #FF0000, #FF6600);
            background-size: 400% 400%;
            animation: gradientShift 3s ease infinite;
            z-index: 999999;
            backdrop-filter: blur(0px);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Efecto de parpadeo fondo */
        @keyframes flashBackground {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .alert-overlay.flashing {
            animation: flashBackground 0.3s infinite, gradientShift 3s ease infinite;
        }

        /* Caja de alerta */
        .alert-box {
            background: rgba(255, 255, 255, 0.98);
            border: 8px solid #FF0000;
            border-radius: 20px;
            padding: 60px 80px;
            max-width: 90vw;
            max-height: 85vh;
            text-align: center;
            box-shadow: 0 0 60px rgba(255, 0, 0, 0.8), 
                        0 0 120px rgba(255, 100, 0, 0.6),
                        inset 0 0 30px rgba(255, 0, 0, 0.3);
            animation: pulseBox 1.5s ease-in-out infinite;
            z-index: 1000000;
        }

        @keyframes pulseBox {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 0 60px rgba(255, 0, 0, 0.8), 
                            0 0 120px rgba(255, 100, 0, 0.6),
                            inset 0 0 30px rgba(255, 0, 0, 0.3);
            }
            50% { 
                transform: scale(1.03);
                box-shadow: 0 0 80px rgba(255, 0, 0, 1), 
                            0 0 150px rgba(255, 100, 0, 0.8),
                            inset 0 0 40px rgba(255, 0, 0, 0.5);
            }
        }

        /* Iconos de alerta */
        .alert-icons {
            font-size: 120px;
            margin-bottom: 20px;
            animation: iconBounce 1s infinite;
        }

        @keyframes iconBounce {
            0%, 100% { transform: translateY(0) scale(1); }
            50% { transform: translateY(-20px) scale(1.1); }
        }

        /* T√≠tulos */
        .alert-title {
            font-size: 80px;
            font-weight: bold;
            color: #FF0000;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            animation: titlePulse 1s infinite;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        @keyframes titlePulse {
            0%, 100% { 
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 0, 0, 0.3);
                transform: scale(1);
            }
            50% { 
                text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 40px rgba(255, 0, 0, 0.8);
                transform: scale(1.05);
            }
        }

        /* Mensaje principal */
        .alert-message {
            font-size: 48px;
            color: #333;
            margin: 30px 0;
            line-height: 1.3;
            font-weight: 600;
            animation: messagePulse 2s ease-in-out infinite;
        }

        @keyframes messagePulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        /* Indicador de lectura */
        .reading-indicator {
            font-size: 24px;
            color: #FF6600;
            margin: 20px 0;
            font-weight: bold;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 49%, 100% { opacity: 1; }
            50%, 99% { opacity: 0.3; }
        }

        /* Contador */
        .countdown {
            font-size: 28px;
            color: #FF0000;
            margin: 20px 0;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        /* Botones */
        .button-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-top: 40px;
        }

        .btn {
            padding: 20px 40px;
            font-size: 24px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.2s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-repeat {
            background-color: #FF6600;
            color: white;
            border: 3px solid #FF0000;
        }

        .btn-repeat:hover {
            background-color: #FF7700;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 100, 0, 0.6);
        }

        .btn-repeat:active {
            transform: scale(0.95);
        }

        .btn-close {
            background-color: #FF0000;
            color: white;
            border: 3px solid #CC0000;
        }

        .btn-close:hover {
            background-color: #CC0000;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6);
        }

        .btn-close:active {
            transform: scale(0.95);
        }

        /* Banda de advertencia en los bordes */
        .warning-band {
            position: fixed;
            background: repeating-linear-gradient(
                45deg,
                #FF0000,
                #FF0000 10px,
                #FFFF00 10px,
                #FFFF00 20px
            );
            opacity: 0.9;
        }

        .warning-band-top {
            top: 0;
            left: 0;
            width: 100%;
            height: 15px;
            z-index: 999998;
        }

        .warning-band-bottom {
            bottom: 0;
            left: 0;
            width: 100%;
            height: 15px;
            z-index: 999998;
        }

        /* Indicador de sonido */
        .sound-indicator {
            font-size: 18px;
            color: #FF6600;
            margin-top: 10px;
            animation: soundPulse 1s infinite;
        }

        @keyframes soundPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body>
    <div class="warning-band warning-band-top"></div>
    <div class="alert-overlay flashing" id="overlay">
        <div class="alert-box">
            <div class="alert-icons">üö®üö®üö®</div>
            
            <div class="alert-title">‚ö†Ô∏è ALERTA URGENTE ‚ö†Ô∏è</div>
            
            <div class="alert-message" id="messageText">
                Cargando mensaje...
            </div>
            
            <div class="reading-indicator">
                üîä Leyendo en voz alta...
            </div>
            
            <div class="sound-indicator">
                üîä Reproduciendo sonido de alerta
            </div>
            
            <div class="countdown">
                Se cerrar√° en <span id="countdown">30</span> segundos
            </div>
            
            <div class="button-group">
                <button class="btn btn-repeat" onclick="repeatAudio()">
                    üîä REPETIR ALERTA
                </button>
                <button class="btn btn-close" onclick="closeAlert()">
                    ‚úì ACEPTAR
                </button>
            </div>
        </div>
    </div>
    <div class="warning-band warning-band-bottom"></div>

    <script>
        let autoCloseTimeout;
        let countdownInterval;
        let countdownValue = 30;
        let audioContext;
        let isPlaying = false;

        // Crear contexto de audio global
        function initAudioContext() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playAlertSound() {
            initAudioContext();
            if (isPlaying) return;
            isPlaying = true;

            // Primer tono agudo
            const osc1 = audioContext.createOscillator();
            const gain1 = audioContext.createGain();
            osc1.connect(gain1);
            gain1.connect(audioContext.destination);
            osc1.frequency.value = 1000; // La
            osc1.type = 'sine';
            gain1.gain.setValueAtTime(0.4, audioContext.currentTime);
            gain1.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
            osc1.start(audioContext.currentTime);
            osc1.stop(audioContext.currentTime + 0.3);

            // Segundo tono m√°s agudo
            setTimeout(() => {
                const osc2 = audioContext.createOscillator();
                const gain2 = audioContext.createGain();
                osc2.connect(gain2);
                gain2.connect(audioContext.destination);
                osc2.frequency.value = 1400; // Do#
                osc2.type = 'sine';
                gain2.gain.setValueAtTime(0.4, audioContext.currentTime);
                gain2.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
                osc2.start(audioContext.currentTime);
                osc2.stop(audioContext.currentTime + 0.3);
            }, 350);

            // Tercer tono
            setTimeout(() => {
                const osc3 = audioContext.createOscillator();
                const gain3 = audioContext.createGain();
                osc3.connect(gain3);
                gain3.connect(audioContext.destination);
                osc3.frequency.value = 1000;
                osc3.type = 'sine';
                gain3.gain.setValueAtTime(0.4, audioContext.currentTime);
                gain3.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
                osc3.start(audioContext.currentTime);
                osc3.stop(audioContext.currentTime + 0.3);
                isPlaying = false;
            }, 700);
        }

        function speakMessage(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'es-ES';
                utterance.rate = 1.1;
                utterance.pitch = 1;
                utterance.volume = 1;
                window.speechSynthesis.speak(utterance);
            }
        }

        function repeatAudio() {
            playAlertSound();
            const message = document.getElementById('messageText').textContent;
            speakMessage(message);
            resetCountdown();
        }

        function resetCountdown() {
            clearTimeout(autoCloseTimeout);
            clearInterval(countdownInterval);
            countdownValue = 30;
            document.getElementById('countdown').textContent = countdownValue;

            countdownInterval = setInterval(() => {
                countdownValue--;
                document.getElementById('countdown').textContent = countdownValue;
                if (countdownValue <= 0) {
                    closeAlert();
                }
            }, 1000);

            autoCloseTimeout = setTimeout(closeAlert, 30000);
        }

        function closeAlert() {
            clearTimeout(autoCloseTimeout);
            clearInterval(countdownInterval);
            window.speechSynthesis.cancel();
            
            // Animar salida
            const overlay = document.getElementById('overlay');
            overlay.style.transition = 'opacity 0.5s';
            overlay.style.opacity = '0';
            
            setTimeout(() => {
                window.close();
            }, 500);
        }

        function loadNotification() {
            fetch('/api/pending-notification')
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        document.getElementById('messageText').textContent = data.message;
                        
                        // Reproducir sonido y habla
                        playAlertSound();
                        setTimeout(() => speakMessage(data.message), 500);
                        
                        // Iniciar cuenta regresiva
                        resetCountdown();
                    }
                })
                .catch(error => {
                    console.error('Error cargando notificaci√≥n:', error);
                    document.getElementById('messageText').textContent = 'Error al cargar el mensaje';
                });
        }

        // Permitir solo ESC o click en botones para salir
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Permitir salir con ESC
                closeAlert();
            }
        });

        // Bloquear cualquier otra interacci√≥n
        document.addEventListener('contextmenu', (e) => e.preventDefault());

        // Cargar notificaci√≥n cuando se carga la p√°gina
        window.addEventListener('load', loadNotification);

        // Evitar que se cierre con Alt+F4 (al menos en algunos navegadores)
        window.addEventListener('beforeunload', (e) => {
            // Solo si est√° en pantalla completa, prevenir cierre
            if (document.fullscreenElement) {
                e.preventDefault();
                return false;
            }
        });
    </script>
</body>
</html>
